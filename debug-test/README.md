# Debugging in Compact

Smart contracts in Compact can be executed standalone, e.g. from TypeScript file. You can debug such smart contract in Visual Studio Code with Midnight VSC Plugin using.

## Setting breakpoints

You can set a breakpoint in TypeScript code using smart contract

![](./docs/images/ts_breakpoint.png/)

or directly in the smart contract source code.

## Features

All tools for [debugging available in VSC](https://code.visualstudio.com/docs/editor/debugging#_launch-configurations) should work:

* stepping into, out and over expressions
* inspecting local variables
* adding custom watch expressions
* navigating through call stack

![](./docs/images/debug.png/)

## Working with watch expressions

Watch expressions use full power of JavaScript syntax and are not limited to Compact syntax.

Window `Variables` shows arguments to transition functions and locally defined variables.

You can add expressions to `Watch` using full power of JavaScript syntax (not just Compact smart contract language).

## Create debug configuration

Assuming output of compilation is set to "out"

```json
{
    "compilerOptions": {
      // ...
      "program": "${file}",
      "outDir": "out",
      // ...
    }
}
```

then in debug configuration - `.vscode/launch.json` - we can use variable `file` to mark a currently selected file as the entry point for debugging:

```json
{
    "configurations": {
      // ...
      "program": "${file}"
      // ...
    }
}
```

If we always want a specific file we could do it as well:

```json
{
    "configurations": {
      // ...
      "program": "${workspaceFolder}/out/testsc.js"
      // ...
    }
}

In order to be able to debug from TypeScript we need to enable source maps generation:

```json
{
    "compilerOptions": {
      // ...
      "sourceMap": true,
      // ...
    }
}
```

and configure paths where to find compiled JS files. It should be enough to write expression matching all JS files in `outFiles`:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            // ...
            "outFiles": [
              "${workspaceFolder}/**/*.js"
            ]
          }
    ]
}
```

Alternative you can separately specify path generated by compiler `${workspaceFolder}/gen/contract/**/*.js` and TypeScript `${workspaceFolder}/out/**/*.js`:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            // ...
            "outFiles": [
              "${workspaceFolder}/gen/contract/**/*.js",
              "${workspaceFolder}/out/**/*.js"
            ]
          }
    ]
}
```

## Configure Modules resolution

In order for properly resolution of [modules](https://www.typescriptlang.org/tsconfig#module) for Node.js, please configure CommonJS in `tsconfig.json`:

```json
{
    "compilerOptions": {
      "target": "es2020",
      "module": "commonjs",
      "esModuleInterop": true,
      // ...
    }
}
```

# Debugging unit tests

*NOTE: example is based on Jest framework*

To debug Jest framework based unit tests:

1. In you project add to `.vscode/launch.json` configuration in `configurations`:

```json lines
{
  "type": "node",
  "request": "launch",
  "name": "Jest: current file",
  "program": "${workspaceFolder}/node_modules/.bin/jest",
  "args": ["${fileBasenameNoExtension}"],
  "console": "integratedTerminal",
  "windows": {
    "program": "${workspaceFolder}/node_modules/jest/bin/jest"
  }
}
```

2. Open test file you want to debug.
3. Set breakpoint where you need to debug.
4. Having test file content displayed, in `Command Palette` find command `Debug: Select and Start Debugging` and then select `Jest: current file` configuration.

Now tests should be executed and debugging mode should start.

# Troubleshooting debugging

## CompactError: Version mismatch

If you encounter error indicating version mismatch, like so:

```text
/nix/store/k10msbi4hkcgf24in809vbsbh7001n49-nodejs-18.15.0/bin/node ./out/test.js
Uncaught CompactError CompactError: Version mismatch: compiled code expects '0.4.0-abcd567', runtime is 0.4.0-1234efg
    at <anonymous> (.../gen/contract/index.js:4:9)
    at Module._compile (internal/modules/cjs/loader:1254:14)
    at Module._extensions..js (internal/modules/cjs/loader:1308:10)
    at ...
index.js:4
Process exited with code 1
```

Then ensure you are using the same version of Compact compiler
e.g. if you are using VSC and separate terminal window type

```sh
compactc --version
```

and check if you have the same version.

Delete all previously compiled artifacts:
* `node_modules`
* output directories like `out`, `dist`, etc.
* compiled smart contract files like `gen` directory

## Configure path from compiled JS to Compact smart contract file

In order for debugging to work we need to compile smart contract.
Therefore your `package.json` should have command for this:

```json
{
  // ...
  "scripts": {
    "compact": "compactc src/foo.compact gen",
    // ...
  }
}
```

Compiler among other things generates the relative path between generated JS file and path to original smart contract.

If the project structure is as follows:

```text
.
├── gen
│   ├── contract
│   │   ├── index.d.ts
│   │   ├── index.js
│   │   └── index.js.map
│   ├── keys
│   │   └── ...
│   └── zkir
│       └── ...
├── node_modules
├── out
│   ├── test.js
│   └── test.js.map
├── package.json
├── src
│   └── myContract.compact
├── test
│   └── test.ts
└── tsconfig.json
```

then relative path between `gen/contract/index.js` and `src/myContract.compact` would be `../../src`, specified in `index.js.map`

```json
{
  "file": "index.js",
  "sourceRoot": "../../",
  "sources": ["src/foo.compact"],
  // ...
}
```

If you have different project structure, you might need to pass `--sourceRoot` flag to modify it:

```sh
compactc --sourceRoot '../../' src/myContract.compact gen
```

## Cannot find module

```text
.../bin/node ./out/test.js
Process exited with code 1
Uncaught Error Error: Cannot find module '.../debug-test/out/test.js'
```

Probably your code is not compiled or your configuration does not contain it

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "node",
            "request": "launch",
            "name": "Launch Compact debug",
            "program": "${workspaceFolder}/out/test.js",
            "outFiles": [
              "${workspaceFolder}/gen/contract/**/*.js",
              "${workspaceFolder}/out/**/*.js"
            ]
          }
    ]
}
```
